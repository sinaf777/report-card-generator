<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report Card Generator - Setup</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    .grade-entry {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    .grade-entry input[type="text"],
    .grade-entry input[type="number"] {
      width: 80px;
    }
    .grade-entry button {
      height: 38px;
    }
    #grading-scale-list {
      max-width: 400px;
    }
    .logo-preview {
      max-height: 100px;
      margin-top: 10px;
    }
  </style>
</head>
<body class="bg-light py-4">
  <div class="container bg-white p-4 rounded shadow-sm">
    <h1 class="mb-4 text-center">Report Card Generator Setup</h1>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert alert-info" role="alert">
      {% for message in messages %}
      <div>{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data" id="main-form" novalidate>
      <!-- School Information -->
      <section class="mb-4">
        <h3 class="mb-3">School Information</h3>
        <div class="mb-3">
          <label for="school_name" class="form-label fw-semibold">School Name</label>
          <input
            type="text"
            id="school_name"
            name="school_name"
            class="form-control"
            placeholder="Enter school name"
            required
            value="{{ school_info.school_name or '' }}"
          />
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="term" class="form-label fw-semibold">Term</label>
            <input
              type="text"
              id="term"
              name="term"
              class="form-control"
              placeholder="e.g., Fall 2025"
              required
              value="{{ school_info.term or '' }}"
            />
          </div>
          <div class="col-md-6">
            <label for="date" class="form-label fw-semibold">Date</label>
            <input
              type="date"
              id="date"
              name="date"
              class="form-control"
              required
              value="{{ school_info.date or '' }}"
            />
          </div>
        </div>

        <div class="mb-3">
          <label for="signature_text" class="form-label fw-semibold">Signature Text</label>
          <input
            type="text"
            id="signature_text"
            name="signature_text"
            class="form-control"
            placeholder="E.g., Principal's Signature"
            value="{{ school_info.signature_text or '' }}"
          />
        </div>

        <div class="mb-3">
          <label for="logo" class="form-label fw-semibold">Upload School Logo</label>
          <input
            type="file"
            id="logo"
            name="logo"
            class="form-control"
            accept="image/*"
          />
          {% if school_info.logo_filename %}
          <div>
            <small class="text-muted">Current Logo:</small>
            <p><strong>{{ school_info.logo_filename }}</strong></p>
            <img
              src="{{ url_for('static', filename='../uploads/' + school_info.logo_filename) }}"
              alt="Logo"
              class="logo-preview"
            />
          </div>
          {% endif %}
        </div>
      </section>

      <!-- Template Selection -->
      <!-- Template Selection -->
      <section class="mb-4">
        <h3 class="mb-3">Choose Report Card Template</h3>
        <div class="d-flex gap-3 flex-wrap">
          {% for t in ['template1', 'template2', 'template3'] %}
        <label
          class="template-option card p-2 text-center"
          style="cursor:pointer; width: 150px; border: 2px solid transparent;"
          for="{{ t }}"
          id="{{ t }}-label"
        >
          <img
            src="{{ url_for('static', filename='templates/' + t + '.png') }}"
            alt="{{ t }}"
            class="img-fluid mb-2"
          />
          <div>{{ t|capitalize }}</div>
          <input
            type="radio"
            name="template"
            id="{{ t }}"
            value="{{ t }}"
            class="d-none"
            {% if school_info.template == t %} checked {% endif %}
            onchange="highlightTemplate('{{ t }}')"
          />
        </label>
          {% endfor %}
        </div>
      </section>

      <!-- Grading Scale -->
      <section class="mb-4">
        <h3 class="mb-3">Grading Scale Setup</h3>
        <div id="grading-scale-list"></div>
        <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addGradeEntry()">
          + Add Grade
        </button>
        <input type="hidden" name="grading_scale_json" id="grading_scale_json" />
      </section>

      <div class="d-grid">
        <button type="submit" class="btn btn-primary btn-lg">Save All</button>
      </div>
    </form>
  </div>

  <script>
    // Load gradingScale from Flask context or default
    let gradingScale = {{ grading_scale|tojson }};

    function renderGradingScale() {
      const container = document.getElementById('grading-scale-list');
      container.innerHTML = '';

      gradingScale.forEach((entry, i) => {
        const div = document.createElement('div');
        div.className = 'grade-entry';

        div.innerHTML = `
          <label class="form-label mb-0">Grade:</label>
          <input type="text" maxlength="2" value="${entry.grade}" onchange="updateGrade(${i}, this.value)" class="form-control" style="width: 80px" required />
          <label class="form-label mb-0">Min Score:</label>
          <input type="number" min="0" max="100" value="${entry.minScore}" onchange="updateMinScore(${i}, this.value)" class="form-control" style="width: 80px" required />
          <button type="button" class="btn btn-danger btn-sm" onclick="removeGradeEntry(${i})" title="Remove Grade">&times;</button>
        `;
        container.appendChild(div);
      });
      updateHiddenInput();
    }

    function addGradeEntry() {
      gradingScale.push({ grade: '', minScore: 0 });
      renderGradingScale();
    }

    function updateGrade(index, value) {
      gradingScale[index].grade = value.toUpperCase();
      updateHiddenInput();
    }

    function updateMinScore(index, value) {
      gradingScale[index].minScore = parseInt(value) || 0;
      updateHiddenInput();
    }

    function removeGradeEntry(index) {
      gradingScale.splice(index, 1);
      renderGradingScale();
    }

    function updateHiddenInput() {
      document.getElementById('grading_scale_json').value = JSON.stringify(gradingScale);
    }

    document.getElementById('main-form').addEventListener('submit', () => {
      updateHiddenInput();
    });

    // Initial render on page load
    // Initial render of grading scale
    renderGradingScale();

    // Highlight selected template card
    function highlightTemplate(selectedId) {
      const labels = document.querySelectorAll('.template-option');
      labels.forEach(label => {
      if (label.id === selectedId + '-label') {
        label.style.borderColor = '#0d6efd';  // Bootstrap primary color
        label.style.backgroundColor = '#e7f1ff';
      } else {
        label.style.borderColor = 'transparent';
        label.style.backgroundColor = '';
      }
      });
    }

    // On page load, highlight the selected template if any
    document.addEventListener('DOMContentLoaded', () => {
      const selectedRadio = document.querySelector('input[name="template"]:checked');
      if (selectedRadio) {
      highlightTemplate(selectedRadio.value);
      }
    });
  </script>
</body>
</html>
